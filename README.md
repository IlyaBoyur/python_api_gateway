# API gateway

Корневой шлюз API для онлайн-кинотеатра.  
Делегирует поисковые запросы пользователей в соответствующие сервисы: в поисковый движок или кэш
Проект представляет собой **http-сервис**, который обрабатывает поступающие запросы.

## Технологии

### Python 3.12, FastAPI, PostgreSQL, Elasticsearch, Redis, uvicorn, Docker, git


## Ключевые особенности
* API спроектировано для конкурентного доступа
* Используется техника `backoff` - плавное увеличение времени повторного запроса в сторонний сервис в случае ошибки, реализовано декоратором `retry_async`
* Используется техника "разрыва цепи" `circuit_breaker` - превышение числа запросов к стороннему сервису за промежуток времени запрещает доступ к сервису на некоторое время 
* Кешируются в `Redis` ответы на запросы API c одинаковыми параметрами. Сделано, чтобы уменьшить нагрузку на `Elasticsearch` 
* Для валидации входных параметров используются схемы `pydantic`
* Для быстрого создания параметров фильтрации, пагинации и сортировки ответов `Elasticsearch` разработан фреймворк фильтрации - класс `AsyncFilterSet` и поля фильтров `SearchFilter`, `LimitOffsetFilter`, `OrderingFilter`, и др.
* Конфигурирование приложения вынесено в переменные среды и переменные уровня модуля.
* Настроена иерархия исключений
* Для ускорения работы API используется реализация цикла событий `uvloop`, схемы `pydantic` используют библиотеку `orjson` для сериализации/десериализации объектов
* Все методы-зависимости `FastAPI` собраны в одном пакете `providers`
* Используется базовый сервис `BaseEntityService` как класс родитель для сервисов данных фильмов, жанров и персон
* Для управления зависимостями используется менеджер пакетов `poetry`


## Важные замечания
* Ожидается, что ElasticDsn указывает на существующий сервис `Elasticsearch`. Можно использовать доменные имена bridge-сети docker "local-dev-network".
* Ожидается, что индексы фильмов (movies), жанров (genres), персон (persons) созданы в `Elasticsearch` и настроены.


## Локальный запуск проекта
1. Подготовьте окружение

* Установите Docker
* Установите docker-compose
* Перейдите в директорию проекта с файлом docker-compose.yaml (по умолчанию: корень проекта)

2. Создайте файл переменных среды 

```shell
# В корне проекта
cp .env.example .env
```

3. Соберите и запустите контейнеры Docker
```shell
# В корне проекта
make init
```

Проект развернут! [Документация API](http://localhost:8080/v1/docs/) 


4. Дополнительные полезные команды
```shell
# В корне проекта
make start        # Запустить контейнеры
make stop         # Остановить контейнеры
make down         # Остановить и удалить контейнеры
make restart      # Остановить и запустить контейнеры
make rebuild      # Пересобрать контейнеры
make ps           # Показать запущенные контейнеры
make logs         # Посмотреть логи всех контейнеров
make logs c=app   # Посмотреть логи бэкенда
make test         # Запустить тесты
make shell        # Получить доступ в контейнер бэкенда
make ipython      # Получить доступ в контейнер бэкенда с интерпретатором ipython
make redis        # Получить доступ в контейнер redis
```


## Авторы

[Илья Боюр](https://github.com/IlyaBoyur)